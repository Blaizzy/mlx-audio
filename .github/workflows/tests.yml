name: Run Python Tests

on:
  pull_request:
    branches:
      - main

jobs:
  # Style checks run once
  style:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run pre-commit
        run: |
          python -m pip install pre-commit
          pre-commit run --all
          if ! git diff --quiet; then
            echo 'Style checks failed. Run: pre-commit run --all-files'
            exit 1
          fi

  # Core tests (DSP, utils) - no optional deps needed
  core:
    runs-on: macos-14
    needs: style
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install core only
        run: pip install -e ".[dev]"

      - name: Test DSP imports without TTS/STT
        run: |
          python -c "from mlx_audio.dsp import stft, mel_filters; print('DSP OK')"
          python -c "from mlx_audio.utils import stft; import sys; assert 'mlx_audio.tts.utils' not in sys.modules; print('Lazy imports OK')"

      - name: Run core tests
        run: pytest -s mlx_audio/tests/

  # Modular installation tests - validates issue #287
  # Only verifies imports work with minimal deps installed.
  # Full tests run separately with all deps (test files import models that need extra deps).
  modular:
    runs-on: macos-14
    needs: style
    strategy:
      fail-fast: false
      matrix:
        include:
          - extra: stt
            verify: "from mlx_audio.stt.utils import load_model"
          - extra: tts
            verify: "from mlx_audio.tts.utils import load_model"
          - extra: sts
            verify: "from mlx_audio.sts import VoicePipeline"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install [${{ matrix.extra }}] only
        run: pip install -e ".[${{ matrix.extra }}]"

      - name: Verify ${{ matrix.extra }} imports
        run: python -c "${{ matrix.verify }}; print('${{ matrix.extra }} imports OK')"

  # Codec tests (part of core, no extra needed)
  codec:
    runs-on: macos-14
    needs: style
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install core
        run: pip install -e ".[dev]"

      - name: Run codec tests
        run: pytest -s mlx_audio/codec/tests/
